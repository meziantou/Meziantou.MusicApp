on:
  workflow_dispatch:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  server:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5

      - name: Run tests
        run: dotnet test

      - name: run local docker registry
        run: docker run -d -p 5000:5000 --name registry registry:latest

      - name: Build base image
        working-directory: Meziantou.MusicApp.Server
        run: docker build --tag localhost:5000/meziantou-music-app-server-base:latest --file Dockerfile.Base .

      - name: push base image
        working-directory: Meziantou.MusicApp.Server
        run: docker push localhost:5000/meziantou-music-app-server-base:latest
      - name: Log in to Docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create image
        run: dotnet publish Meziantou.MusicApp.Server --os linux --arch x64 --configuration Release /t:PublishContainer

  player:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'
          cache-dependency-path: Meziantou.MusicApp.WebPlayer/package-lock.json

      - name: Install dependencies
        working-directory: Meziantou.MusicApp.WebPlayer
        run: npm ci

      - name: Run tests
        working-directory: Meziantou.MusicApp.WebPlayer
        run: npm test

      - name: Build application
        working-directory: Meziantou.MusicApp.WebPlayer
        run: npm run build
        env:
          VITE_COMMIT_HASH: ${{ github.sha }}

      - name: Log in to Docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push web player image
        uses: docker/build-push-action@v6
        with:
          context: Meziantou.MusicApp.WebPlayer
          file: Meziantou.MusicApp.WebPlayer/Dockerfile
          push: true
          build-args: |
            VITE_COMMIT_HASH=${{ github.sha }}
          tags: |
            ghcr.io/meziantou/meziantou-music-app-web-player:1.0.${{ github.run_number }}
            ghcr.io/meziantou/meziantou-music-app-web-player:latest

  static-site-generator:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
        contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5

      - name: Publish StaticSiteGenerator for Windows x64
        run: dotnet publish Meziantou.MusicApp.StaticSiteGenerator --configuration Release --runtime win-x64 --self-contained --output ./publish/win-x64

      - name: Publish StaticSiteGenerator for Windows arm64
        run: dotnet publish Meziantou.MusicApp.StaticSiteGenerator --configuration Release --runtime win-arm64 --self-contained --output ./publish/win-arm64

      - name: Publish StaticSiteGenerator for Linux x64
        run: dotnet publish Meziantou.MusicApp.StaticSiteGenerator --configuration Release --runtime linux-x64 --self-contained --output ./publish/linux-x64

      - name: Publish StaticSiteGenerator for macOS arm64
        run: dotnet publish Meziantou.MusicApp.StaticSiteGenerator --configuration Release --runtime osx-arm64 --self-contained --output ./publish/osx-arm64

      - name: Create release archives
        run: |
          cd publish
          zip -r ../StaticSiteGenerator-win-x64.zip win-x64/
          zip -r ../StaticSiteGenerator-win-arm64.zip win-arm64/
          tar -czf ../StaticSiteGenerator-linux-x64.tar.gz -C linux-x64 .
          tar -czf ../StaticSiteGenerator-osx-arm64.tar.gz -C osx-arm64 .
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Static Site Generator v1.0.${{ github.run_number }}
          body: |
            ## Static Site Generator Release

            Generate static music streaming sites from XSPF playlists.

            ### Features
            - Converts audio files to Opus format
            - Generates REST API compatible JSON files
            - Cross-platform support

            ### Downloads
            - **Windows x64**: StaticSiteGenerator-win-x64.zip
            - **Windows arm64**: StaticSiteGenerator-win-arm64.zip
            - **Linux x64**: StaticSiteGenerator-linux-x64.tar.gz
            - **macOS arm64**: StaticSiteGenerator-osx-arm64.tar.gz

            ### Requirements
            - ffmpeg and ffprobe must be installed and available in PATH

            ### Usage
            ```bash
            # Windows
            StaticSiteGenerator.exe --playlists playlist.xspf --output ./output

            # Linux/macOS
            ./StaticSiteGenerator --playlists playlist.xspf --output ./output
            ```

            See [README](https://github.com/meziantou/Meziantou.MusicApp/tree/main/Meziantou.MusicApp.StaticSiteGenerator) for full documentation.
          files: |
            StaticSiteGenerator-win-x64.zip
            StaticSiteGenerator-win-arm64.zip
            StaticSiteGenerator-linux-x64.tar.gz
            StaticSiteGenerator-osx-x64.tar.gz
            StaticSiteGenerator-osx-arm64.tar.gz
          draft: false
          prerelease: false