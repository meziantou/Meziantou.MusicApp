on:
  workflow_dispatch:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  server:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Annotate with image version
        run: |
          IMAGE_VERSION="${{ github.run_number }}"
          echo "::notice title=Docker Image Version::ghcr.io/meziantou/meziantou-music-app-server:${IMAGE_VERSION}"
          echo "::notice title=Docker Image Latest::ghcr.io/meziantou/meziantou-music-app-server:latest"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5

      - name: Run tests
        run: dotnet test

      - name: run local docker registry
        run: docker run -d -p 5000:5000 --name registry registry:latest

      - name: Build base image
        working-directory: Meziantou.MusicApp.Server
        run: docker build --tag localhost:5000/meziantou-music-app-server-base:latest --file Dockerfile.Base .

      - name: push base image
        working-directory: Meziantou.MusicApp.Server
        run: docker push localhost:5000/meziantou-music-app-server-base:latest
      - name: Log in to Docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create image
        run: dotnet publish Meziantou.MusicApp.Server --os linux --arch x64 --configuration Release /t:PublishContainer

  player:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        packages: write
    steps:
      - uses: actions/checkout@v5

      - name: Annotate with image version
        run: |
          IMAGE_VERSION="${{ github.run_number }}"
          echo "::notice title=Web Player Image Version::ghcr.io/meziantou/meziantou-music-app-web-player:${IMAGE_VERSION}"
          echo "::notice title=Web Player Image Latest::ghcr.io/meziantou/meziantou-music-app-web-player:latest"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: Meziantou.MusicApp.WebPlayer/package-lock.json

      - name: Install dependencies
        working-directory: Meziantou.MusicApp.WebPlayer
        run: npm ci

      - name: Run tests
        working-directory: Meziantou.MusicApp.WebPlayer
        run: npm test

      - name: Log in to Docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push web player image
        uses: docker/build-push-action@v6
        with:
          context: Meziantou.MusicApp.WebPlayer
          file: Meziantou.MusicApp.WebPlayer/Dockerfile
          push: true
          tags: |
            ghcr.io/meziantou/meziantou-music-app-web-player:${{ github.run_number }}
            ghcr.io/meziantou/meziantou-music-app-web-player:latest